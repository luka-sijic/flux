{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file:///Users/based/Documents/projects/websocket/message/frontend/src/app/ws/page.tsx"],"sourcesContent":["\"use client\";\nimport axios from \"axios\";\nimport { useState, useEffect, useRef } from \"react\";\nimport { Circle, Plus, Handshake } from \"lucide-react\";\nimport { useRouter } from \"next/navigation\";\nimport toast from \"react-hot-toast\";\nimport refreshToken from '@/lib/auth';\naxios.defaults.withCredentials = true\n\ntype WSMessage = {\n  type: \"join\" | \"chat\" | \"users\" | \"log\" | \"ping\";\n  user?: string;\n  content?: string;\n  users?: Record<string, string>;\n  log?: string[];\n};\n\ntype Friend = {\n  friend: string;\n};\n\ntype Message = {\n  username: string;\n  message: string;\n}\n\nexport default function Home() {\n  const router = useRouter();\n  const connection = useRef<WebSocket | null>(null);\n  const [username, setUsername] = useState<string>(\"\");\n  const [friends, setFriends] = useState<Friend[]>([]);\n  const [inputValue, setInputValue] = useState<string>(\"\");\n  const [friend, setFriendValue] = useState<string>(\"\");\n  const [messages, setMessages] = useState<WSMessage[]>([]);\n  const [addFriend, setAddFriend] = useState<Boolean>(false);\n  const [log, setLog] = useState<Message[]>([]);\n  const [active, setActive] = useState<string>('');\n  const [users, setUsers] = useState<Record<string, string>>({});\n\n  useEffect(() => {\n    const fetchUsername = async () => {\n      try {\n        const res = await axios.get('http://127.0.0.1:8081/me', {withCredentials: true});\n        console.log(res);\n        if (res.status === 200) {\n          setUsername(res.data);\n        } else {\n          console.log(\"can't find username\");\n        }\n      } catch (err: any) {\n        if (err.response?.status === 500) {\n          try {\n            const res = await axios.get('http://127.0.0.1:8081/refresh', {withCredentials: true});\n            console.log(\"IDK: \", res);\n            await axios.get('http://127.0.0.1:8081/me', {withCredentials: true});\n          } catch (err) {\n            console.log(\"ERROR2\", err);\n          }\n        }\n        router.replace(\"/ws\");\n        console.log(\"TEST\");\n        console.log(err);\n      }\n    }\n    fetchUsername();\n  }, []);\n\n  useEffect(() => {\n    if (!username) return;\n    const fetchFriends = async () => {\n      try {\n        const response = await axios.get(\n          `http://127.0.0.1:8081/friend/${username}`\n        );\n        if (response.status === 200) {\n          setFriends(response.data);\n          console.log(response.data);\n        }\n      } catch (err) {\n        console.log(\"NO FRIENDS\");\n      }\n    };\n    fetchFriends();\n  }, [username]);\n\n  useEffect(() => {\n    const socket = new WebSocket(\"ws://127.0.0.1:8080/ws\");\n\n    socket.onopen = () => {\n      console.log(\"Connection opened\");\n    };\n\n    socket.onmessage = (event) => {\n      const data = JSON.parse(event.data) as WSMessage;\n\n      switch (data.type) {\n        case \"log\":\n          console.log(data);\n          const byteLen = new TextEncoder().encode(JSON.stringify(data)).length;\n          console.log(\"Length: \" + byteLen);\n          //setLog(data.log ?? []);\n        case \"users\":\n          // data.users is string[] or undefined â†’ default to []\n          setUsers(data.users ?? {});\n          break;\n\n        case \"chat\":\n          // append the new WSMessage to our array\n          setMessages((prev) => [...prev, data]);\n          break;\n        case \"ping\":\n          socket.send(JSON.stringify({ type: \"pong\" }));\n          break;\n      }\n    };\n\n    connection.current = socket;\n    return () => {\n      socket.close();\n    };\n  }, []);\n\n  const addNewFriend = async (e: React.FormEvent) => {\n    e.preventDefault();\n    try {\n      const res = await axios.post(\"http://127.0.0.1:8081/friend\", { friend });\n      toast.success(\"Friend request sent\");\n      setFriendValue(\"\");\n      if (res.status === 200) {\n        console.log(\"friend addded\");\n      }\n    } catch (err) {\n      if (axios.isAxiosError(err) && err.response) {\n        if (err.response.status === 404) {\n          toast.error(\"User not found ðŸ¤”\", {\n            className: \"bg-red-400\",\n          });\n          setFriendValue(\"\");\n          console.log(\"No user exists\");\n        }\n      }\n    }\n  };\n\n  const handleFriend = async (e: React.FormEvent) => {\n    e.preventDefault();\n    setAddFriend(!addFriend);\n  };\n\n  const handleSubmit = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (\n      !connection.current ||\n      connection.current.readyState !== WebSocket.OPEN\n    ) {\n      console.error(\"WebSocket not open\");\n      return;\n    }\n\n    // Afterwards, send chat messages\n    const content = inputValue.trim();\n    if (content.length) if (!content) return;\n    connection.current.send(\n      JSON.stringify({ type: \"chat\", user: username, content })\n    );\n    setInputValue(\"\");\n  };\n\n  const friendRequests = async () => {\n    void router.push(\"/requests\");\n  };\n\n  const getMessages = async (friend: string) => {\n    try {\n      const response = await axios.get(`http://127.0.0.1:8081/friend/${username}/${friend}`);\n      console.log(\"MESSAGE GET RESPONSE: \", response);\n      if (response.status === 200) {\n        console.log(response);\n        setLog(response.data);\n      }\n    } catch (err) {\n      console.log(\"ERROR\");\n    }\n  }\n\n  return (\n    <div className=\"flex h-screen overflow-x-hidden\">\n      <div className=\"w-64 border border-white rounded p-4 bg-black text-white\">\n        <div className=\"flex justify-between\">\n          <h2 className=\"text-xl font-semibold mb-4\">Friends</h2>\n          <form onSubmit={handleFriend}>\n            <button type=\"submit\">\n              <Plus className=\"cursor-pointer\" />\n            </button>\n            <button onClick={friendRequests}>\n              <Handshake size={20} className=\"cursor-pointer\" />\n            </button>\n          </form>\n        </div>\n        {addFriend ? (\n          <form onSubmit={addNewFriend}>\n            <input\n              value={friend}\n              onChange={(e) => setFriendValue(e.target.value)}\n              placeholder=\"add friend...\"\n              className=\"bg-gray-800 rounded p-1\"\n            />\n          </form>\n        ) : (\n          \"\"\n        )}\n        {/* 1) Users column */}\n        {/*<ul>\n          {Object.keys(users).length === 0 ? (\n            <p className=\"text-gray-500 py-2\">No users connected</p>\n          ) : (\n            Object.entries(users).map(([key, value]) => (\n              <li key={key} className=\"flex items-center gap-1\">\n                <Circle\n                  size={12}\n                  stroke=\"none\"\n                  fill=\"currentColor\"\n                  className={\n                    value === \"active\" ? \"text-green-500\" : \"text-red-500\"\n                  }\n                />\n                <span>{key}</span>\n              </li>\n            ))\n          )}\n        </ul>*/}\n        <ul>\n          {friends.length > 0 ? (\n            friends.map((f, i) => \n              <li key={i} className=\"flex justify-between w-22 text-gray-300 text-xl cursor-pointer\">\n                  <button type=\"button\" onClick={() => getMessages(f.friend)} className=\"flex items-center gap-2 cursor-pointer\">\n                  <img className=\"w-7 h-7 rounded-2xl\" src=\"https://avatars.akamai.steamstatic.com/7d88fb593b5030a1d1d2cfb8b05d282bc07fc389_full.jpg\" />\n                  {f.friend}\n                  </button>\n              </li>\n          )) : (\n            <li>No friends found</li>\n          )}\n        </ul>\n      </div>\n      {/* Chat Column */}\n      <div className=\"flex flex-col flex-1 p-4 min-h-0\">\n        {/* Messages: now fills full height and only scrolls vertically */}\n        <div\n          className=\"\n        flex-1                /* take up all remaining vertical space */\n        overflow-y-auto       /* vertical scrolling as needed */\n        overflow-x-hidden     /* hide any horizontal overflow */\n        border rounded p-3\n        whitespace-pre-wrap\n        break-words           /* wrap long words */\n        break-all             /* break really long tokens if needed */\n        bg-black text-white\n      \"\n        >\n          {log.map((m, i) => (\n            <p key={i}>{m.username}: {m.message}</p>\n          ))}\n          {messages.map((m, i) => (\n            <p key={i}>\n              <strong>{m.user}:</strong> {m.content}\n            </p>\n          ))}\n        </div>\n\n        <form onSubmit={handleSubmit} className=\"flex mt-4 space-x-2\">\n          <input\n            type=\"text\"\n            value={inputValue}\n            onChange={(e) => setInputValue(e.target.value)}\n            placeholder=\"Send message\"\n            minLength={2}\n            maxLength={200}\n            required\n            className=\"flex-1 border rounded px-3 py-2 focus:outline-none focus:ring\"\n          />\n          <button\n            type=\"submit\"\n            className=\"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition\"\n          >\n            {username ? \"Send\" : \"Join\"}\n          </button>\n        </form>\n      </div>\n    </div>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}